name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install linters
        run: pip install flake8
      
      - name: Check code quality
        run: flake8 src/ --max-line-length=120 --ignore=E,W,F

  data-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install pandas
        run: pip install pandas
      
      - name: Validate data quality
        run: |
          python -c "
          import pandas as pd
          df = pd.read_csv('data/raw/data.csv')
          assert len(df) > 100, 'Not enough data'
          required = ['Glucose', 'BloodPressure', 'SkinThickness', 'Insulin', 'BMI', 'Age', 'Pregnancies']
          for col in required:
              assert col in df.columns, f'Missing {col}'
          print(f'Data validation passed: {len(df)} rows')
          "

  model-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install pandas numpy scikit-learn
      
      - name: Validate model performance
        run: |
          python -c "
          import pandas as pd
          import numpy as np
          from sklearn.model_selection import train_test_split
          from sklearn.ensemble import RandomForestClassifier
          from sklearn.metrics import accuracy_score
          from sklearn.impute import KNNImputer
          from imblearn.over_sampling import RandomOverSampler
          from sklearn.preprocessing import StandardScaler
          from sklearn.svm import SVC
          
          data = pd.read_csv('data/raw/data.csv')
          if "Unnamed: 0" in data.columns:
            data = data.drop(columns=["Unnamed: 0"])
          
          cols_with_zeros = ['Glucose', 'BloodPressure', 'SkinThickness', 'Insulin', 'BMI']
          data[cols_with_zeros] = data[cols_with_zeros].replace(0, np.nan)
          
          imputer = KNNImputer(n_neighbors=5)
          data[cols_with_zeros] = imputer.fit_transform(data[cols_with_zeros])
          
          scaler = StandardScaler()
          numeric_cols = data.select_dtypes(include=[np.number]).columns
          data[numeric_cols] = scaler.fit_transform(data[numeric_cols])
          
          labeled_data = pd.read_csv(data/labeled/data.csv)

          X = data
          y = labeled_data['Cluster']

          X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
    
          ros = RandomOverSampler(random_state=42)
          
          X_train, y_train = ros.fit_resample(X_train, y_train)
          X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
          
          model = SVC(C=10, gamma='scale', kernel='linear', probability=True, random_state=42)
          model.fit(X_train, y_train)
          
          y_pred = clf.predict(X_test)
          accuracy = accuracy_score(y_test, y_pred)
          
          assert accuracy > 0.8, f'Accuracy {accuracy:.2f} below 0.8'
          print(f'Model validation passed: accuracy={accuracy:.2f}')
          "

  build:
    runs-on: ubuntu-latest
    needs: [code-quality, data-validation, model-validation]
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -f docker/Dockerfile -t diabops:test .

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pytest httpx
          pip install -r requirements.txt
      
      - name: Run tests
        run: pytest tests/ -v